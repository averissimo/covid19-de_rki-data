---
title: "Germany data on district level"
output: 
  github_document:
    dev: svg
  html_document:
    toc: true
    dev: svg
---

```{r, eval=FALSE, include=FALSE}
rmarkdown::render('index.Rmd', output_format = rmarkdown::github_document(), output_file = 'README.md')
unlink('../README.md')
unlink('../README_files', recursive = TRUE, force = TRUE)
file.copy('README.md', '../README.md')
file.copy('README_files', '..', recursive = TRUE, overwrite = TRUE)
unlink('README.md')
unlink('README.html')
unlink('README_files', recursive = TRUE, force = TRUE)
rmarkdown::render_site()
```


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, collapse = TRUE, fig.height=8, fig.width=10)
library(tidyverse)
library(rjson)
library(anytime)
library(glue)
library(DT)
library(futile.logger)
library(viridis)
library(ggthemes)
library(ggrepel)

flog.threshold('info')
flog.layout(layout.format('~m'))

Sys.setlocale('LC_TIME', 'en_GB.UTF-8')

devtools::load_all()
```






> COVID-19 District level data from Robert Koch Institute in Germany

The data is updated daily and is downloaded from a ARCGIS REST API using the [RKI_COVID19](https://services7.arcgis.com/mOBPykOjAyBO2ZKk/arcgis/rest/services/RKI_COVID19/FeatureServer/0/query?where=Meldedatum+%3E+(CURRENT_TIMESTAMP+-+3)&objectIds=&time=&resultType=none&outFields=*&returnIdsOnly=false&returnUniqueIdsOnly=false&returnCountOnly=false&returnDistinctValues=false&cacheHint=false&orderByFields=Meldedatum&outStatistics=&having=&resultOffset=&resultRecordCount=&sqlFormat=none&f=html&token=) feature server.

Data from previous dates can be changed over time and update the data files accordingly, therefore `object.id` for any given row will change daily.

Source code available at [averissimo/covid19-rki_de-data](https://github.com/averissimo/covid19-de_rki-data).

**Other covid-19 related:**

* [World](https://averissimo.github.io/covid19-analysis/)
* [Germany](https://averissimo.github.io/covid19-analysis/germany.html) *(by state)*
* [Italy](https://averissimo.github.io/covid19-analysis/italy.html) *(by regione)*
* [Bavaria](https://averissimo.github.io/covid19-analysis/bayer.html) *(Germany)*


## Install / Usage

The data is available inside the `data/` folder in `.csv` format. 

It can also be used as an *R package* by installing this repository directly:

```{r, eval=FALSE, echo=TRUE}
> BiocManager::install_github('averissimo/covid19-de_rki-data')
# or
> devtools::install_github('averissimo/covid19-de_rki-data')
```

## Update data

To retrieve the lastest yourself use the following function of the R package. 

```{r, eval=FALSE, echo=TRUE}
> rki.de.district.data::update.dataset()
```

Note that, as of now, the data is updated by the Robert Koch Institute once a day.

```{r, include=FALSE}
rki.covid19.tmp <- update.dataset()
```

```{r, include=FALSE}
data('rki.covid19')
if (!exists('rki.covid19') || (!all(rki.covid19.tmp$object.id %in% rki.covid19$object.id))) {
  rki.covid19 <- rki.covid19.tmp
  usethis::use_data(rki.covid19, overwrite = TRUE)
  write_csv2(rki.covid19, path = '../data/rki.covid19.csv')
}
```


```{r, include=FALSE}
my.rki <- rki.covid19 %>%
  add.factors %>% 
  #group_by(id.state, state, id.district, district, gender, age.group) %>%
  arrange(date)

top.states <- my.rki %>% group_by(state) %>% summarise(cases = sum(deaths) * sum(cases)) %>% arrange(-cases) %>% pull(state)
top.districts <- my.rki %>% group_by(district) %>% summarise(cases = sum(deaths) * sum(cases)) %>% arrange(-cases) %>% pull(district)
```

## Data visualization

### New cases/deaths per day *in most affected states/districts* {.tabset .tabset-fade .tabset-pills}

#### New Cases in states

```{r}
my.rki %>% 
  filter(state %in% (top.states %>% head(8))) %>%
  filter(anydate(base::date()) - date <= 12) %>% 
  arrange(desc(date)) %>% 
  group_by(state, date) %>%
  summarize(cases = sum(cases)) %>%
  arrange(date) %>% 
  mutate(label = if_else(date == last(date), paste0(state, ' (', format(cases, big.mark = ','), ')'),'')) %>% 
  ggplot(aes(x = date, y = cases, color = state)) + 
    geom_line(size = 1.2) + 
    geom_point(size = 2) + 
    geom_label_repel(aes(label = label, fill = state), 
                     na.rm = TRUE, alpha = .8, color = 'white', size = 3, segment.alpha = .4, segment.colour = 'black', force = 5) +
    scale_color_viridis_d(end = .8) + 
    scale_fill_viridis_d(end = .8) + 
    theme_minimal() +
    theme(legend.position = 'none') +
    labs(title = 'New cases per day in last 12 days', y = 'Cases', x = 'Day',
         subtitle = 'Showing only 8 most affected states')
```

#### New Deaths in states

```{r}
my.rki %>% 
  filter(state %in% (top.states %>% head(8))) %>%
  filter(anydate(base::date()) - date <= 12) %>% 
  arrange(desc(date)) %>% 
  group_by(state, date) %>%
  summarize(cases = sum(deaths)) %>%
  arrange(date) %>% 
  mutate(label = if_else(date == last(date), paste0(state, ' (', format(cases, big.mark = ','), ')'),'')) %>% 
  ggplot(aes(x = date, y = cases, color = state)) + 
    geom_line(size = 1.2) + 
    geom_point(size = 2) + 
    geom_label_repel(aes(label = label, fill = state), 
                     na.rm = TRUE, alpha = .8, color = 'white', size = 3, segment.alpha = .4, segment.colour = 'black', force = 5) +
    scale_color_viridis_d(end = .8) + 
    scale_fill_viridis_d(end = .8) + 
    theme_minimal() +
    theme(legend.position = 'none') +
    labs(title = 'New deaths per day in last 12 days', y = 'Deaths', x = 'Day',
         subtitle = 'Showing only 8 most affected states')
```

#### New cases in districts

```{r}
my.rki %>% 
  filter(district %in% (top.districts %>% head(8))) %>%
  filter(anydate(base::date()) - date <= 12) %>% 
  arrange(desc(date)) %>% 
  group_by(district, date) %>%
  summarize(cases = sum(cases)) %>%
  arrange(date) %>% 
  mutate(label = if_else(date == last(date), paste0(district, ' (', format(cases, big.mark = ','), ')'),'')) %>% 
  ggplot(aes(x = date, y = cases, color = district)) + 
    geom_line(size = 1.2) + 
    geom_point(size = 2) + 
    geom_label_repel(aes(label = label, fill = district), 
                     na.rm = TRUE, alpha = .8, color = 'white', size = 3, segment.alpha = .4, segment.colour = 'black', force = 4) +
    scale_color_viridis_d(end = .9) + 
    scale_fill_viridis_d(end = .9) + 
    theme_minimal() +
    theme(legend.position = 'none') +
    labs(title = 'New cases per day in last 12 days', y = 'Cases', x = 'Day',
         subtitle = 'Showing only 8 most affected states')
```

#### New deaths in districts

```{r}
my.rki %>% 
  filter(district %in% (top.districts %>% head(8))) %>%
  filter(anydate(base::date()) - date <= 12) %>% 
  arrange(desc(date)) %>% 
  group_by(district, date) %>%
  summarize(cases = sum(deaths)) %>%
  arrange(date) %>% 
  mutate(label = if_else(date == last(date), paste0(district, ' (', format(cases, big.mark = ','), ')'),'')) %>% 
  ggplot(aes(x = date, y = cases, color = district)) + 
    geom_line(size = 1.2) + 
    geom_point(size = 2) + 
    geom_label_repel(aes(label = label, fill = district), 
                     na.rm = TRUE, alpha = .8, color = 'white', size = 3, segment.alpha = .4, segment.colour = 'black', force = 4) +
    scale_color_viridis_d(end = .9) + 
    scale_fill_viridis_d(end = .9) + 
    theme_minimal() +
    theme(legend.position = 'none') +
    labs(title = 'New cases per day in last 12 days', y = 'Cases', x = 'Day',
         subtitle = 'Showing only 8 most affected districts')
```

### Total cases in last 12 days *in most affected states/districts* {.tabset .tabset-fade .tabset-pills}

#### Total cases in states

```{r}
my.rki %>% 
  filter(state %in% (top.states %>% head(8))) %>%
  filter(anydate(base::date()) - date <= 12) %>% 
  arrange(date) %>% 
  group_by(state, date) %>%
  summarize(cases = sum(cases)) %>%
  mutate(cumul.cases = cumsum(cases),
         label = if_else(date == last(date), paste0(state, '(', format(cumul.cases, big.mark=','), ')'), '')) %>%
  ggplot(aes(x = date, y = cumul.cases, color = state)) + 
    geom_line(size = 1.2) + 
    geom_point(size = 2) + 
    geom_label_repel(aes(label = label, fill = state), 
                     na.rm = TRUE, alpha = .8, color = 'white', size = 3, segment.alpha = .4, segment.colour = 'black', force = 2) +
    scale_color_viridis(discrete = TRUE, end = .5) +
    scale_fill_viridis(discrete = TRUE, end = .5) + 
    theme_minimal() +
    theme(legend.position = 'none') +
    labs(title = 'Total cases per day in last 12 days', y = 'Total Cases', x = 'Day',
         subtitle = 'Showing only 8 most affected states')
```

#### Total deaths in states

Showing only 6 states most affected

```{r}
my.rki %>% 
  filter(state %in% (top.states %>% head(8))) %>%
  filter(anydate(base::date()) - date <= 12) %>% 
  arrange(date) %>% 
  group_by(state, date) %>%
  summarize(cases = sum(deaths)) %>%
  mutate(cumul.cases = cumsum(cases),
         label = if_else(date == last(date), paste0(state, '(', format(cumul.cases, big.mark=','), ')'), '')) %>%
  ggplot(aes(x = date, y = cumul.cases, color = state)) + 
    geom_line(size = 1.2) + 
    geom_point(size = 2) + 
    geom_label_repel(aes(label = label, fill = state), 
                     na.rm = TRUE, alpha = .8, color = 'white', size = 3, segment.alpha = .4, segment.colour = 'black', force = 2) +
    scale_color_viridis(discrete = TRUE, end = .5) +
    scale_fill_viridis(discrete = TRUE, end = .5) + 
    theme_minimal() +
    theme(legend.position = 'none') +
    labs(title = 'Total deaths per day in last 12 days', y = 'Total Deaths', x = 'Day',
         subtitle = 'Showing only 8 most affected states')
```

#### Total cases in districs

Showing only 6 districs most affected

```{r}
my.rki %>% 
  filter(district %in% (top.districts %>% head(8))) %>%
  filter(anydate(base::date()) - date <= 12) %>% 
  arrange(date) %>% 
  group_by(district, date) %>%
  summarize(cases = sum(cases)) %>%
  mutate(cumul.cases = cumsum(cases),
         label = if_else(date == last(date), paste0(district, '(', format(cumul.cases, big.mark=','), ')'), '')) %>%
  ggplot(aes(x = date, y = cumul.cases, color = district)) + 
    geom_line(size = 1.2) + 
    geom_point(size = 2) + 
    geom_label_repel(aes(label = label, fill = district), 
                     na.rm = TRUE, alpha = .8, color = 'white', size = 3, segment.alpha = .4, segment.colour = 'black', force = 2) +
    scale_color_viridis(discrete = TRUE, end = .5) +
    scale_fill_viridis(discrete = TRUE, end = .5) + 
    theme_minimal() +
    theme(legend.position = 'none') +
    labs(title = 'Total cases per day in last 12 days', y = 'Total Cases', x = 'Day',
         subtitle = 'Showing only 8 most affected districts')
```

#### Total deaths in districs

Showing only 6 districs most affected

```{r}
my.rki %>% 
  filter(district %in% (top.districts %>% head(8))) %>%
  filter(anydate(base::date()) - date <= 12) %>% 
  arrange(date) %>% 
  group_by(district, date) %>%
  summarize(cases = sum(deaths)) %>%
  mutate(cumul.cases = cumsum(cases),
         label = if_else(date == last(date), paste0(district, '(', format(cumul.cases, big.mark=','), ')'), '')) %>%
  ggplot(aes(x = date, y = cumul.cases, color = district)) + 
    geom_line(size = 1.2) + 
    geom_point(size = 2) + 
    geom_label_repel(aes(label = label, fill = district), 
                     na.rm = TRUE, alpha = .8, color = 'white', size = 3, segment.alpha = .4, segment.colour = 'black', force = 2) +
    scale_color_viridis(discrete = TRUE, end = .5) +
    scale_fill_viridis(discrete = TRUE, end = .5) + 
    theme_minimal() +
    theme(legend.position = 'none') +
    labs(title = 'Total deaths per day in last 12 days', y = 'Total Deaths', x = 'Day',
         subtitle = 'Showing only 8 most affected districts')
```

### Cases by age groups {.tabset .tabset-fade .tabset-pills}

#### Cases in states

```{r}
age.plot.state(my.rki, 'cases', top.states %>% head(8), 'Cases in States')
```

#### Deaths in states

```{r}
age.plot.state(my.rki, 'deaths', top.states %>% head(8), 'Deaths in States')
```

#### Cases in districts

```{r}
age.plot.district(my.rki, 'cases', top.districts %>% head(8), 'Number of Cases')
```

#### Deaths in districts

```{r}
age.plot.district(my.rki, 'deaths', top.districts %>% head(8), 'Number of Deaths')
```



